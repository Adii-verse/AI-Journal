<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Motivational Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .journal-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <div class="container mx-auto max-w-3xl px-4 py-8 md:py-12">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 tracking-tight">AI Motivational Journal</h1>
            <p class="text-lg text-gray-600 mt-2">Your daily dose of AI-powered inspiration and reflection.</p>
        </header>

        <main>
            <!-- AI Generation Section -->
            <div class="mb-8 p-6 rounded-2xl shadow-lg journal-card">
                <h2 class="text-2xl font-semibold mb-4 text-center">Today's Inspiration</h2>
                <div class="flex justify-center">
                    <button id="generate-btn" class="flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-5 w-5"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                        <span>Get Today's Motivation</span>
                    </button>
                </div>
                
                <div id="loader" class="hidden justify-center my-4"><div class="loader"></div></div>

                <div id="generated-entry-container" class="hidden mt-6 p-5 bg-white/70 rounded-xl">
                    <p id="generated-text" class="text-gray-700 whitespace-pre-wrap"></p>
                    <div class="text-right mt-4">
                        <button id="save-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-5 rounded-lg transition-all shadow-sm">Save Entry</button>
                    </div>
                </div>
            </div>

            <!-- Saved Journal Entries -->
            <div class="p-6 rounded-2xl shadow-lg journal-card">
                <h2 class="text-2xl font-semibold mb-4 text-center border-b pb-3">My Journal</h2>
                <div id="journal-history" class="space-y-4">
                    <p id="empty-state" class="text-center text-gray-500 py-4">Your saved journal entries will appear here.</p>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-12 text-gray-500">
             <p>Powered by Generative AI</p>
        </footer>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, setLogLevel, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM Elements
        const generateBtn = document.getElementById('generate-btn');
        const loader = document.getElementById('loader');
        const generatedEntryContainer = document.getElementById('generated-entry-container');
        const generatedText = document.getElementById('generated-text');
        const saveBtn = document.getElementById('save-btn');
        const journalHistory = document.getElementById('journal-history');
        const emptyState = document.getElementById('empty-state');
        
        // App State
        let currentUserId = null;
        let currentGeneratedEntry = null;
        let db;

        // --- Firebase Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ai-journal-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        if (!firebaseConfig) {
            console.error("Firebase config is not available.");
            // Display an error to the user
            journalHistory.innerHTML = '<p class="text-center text-red-500">Could not connect to the database. Please try again later.</p>';
        } else {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("User is signed in with UID:", currentUserId);
                        fetchAndRenderEntries();
                    } else {
                        console.log("No user signed in, attempting to sign in...");
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Error signing in:", error);
                        }
                    }
                });
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                journalHistory.innerHTML = '<p class="text-center text-red-500">Could not initialize the application.</p>';
            }
        }
        
        // --- AI Model Interaction ---
        async function generateJournalEntry() {
            generateBtn.disabled = true;
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            loader.classList.remove('hidden');
            loader.classList.add('flex');
            generatedEntryContainer.classList.add('hidden');

            const systemPrompt = "You are an inspiring and compassionate motivational coach. Your goal is to write a short, personal, and uplifting journal entry. Write in the first person (using 'I', 'my', 'me'). The entry should be reflective, positive, and end with a gentle, actionable piece of advice or a thought-provoking question for the day. Keep it concise, around 3-4 sentences.";
            const userQuery = "Write today's motivational journal entry for me.";
            const apiKey = ""; // API key is handled by the environment.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let success = false;
            let retries = 3;
            let delay = 1000;

            while(retries > 0 && !success) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        currentGeneratedEntry = text.trim();
                        generatedText.innerText = currentGeneratedEntry;
                        generatedEntryContainer.classList.remove('hidden');
                        success = true;
                    } else {
                        throw new Error("Invalid response structure from AI model.");
                    }
                } catch (error) {
                    console.error(`Error generating entry (retries left: ${retries-1}):`, error);
                    retries--;
                    if(retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                         generatedText.innerText = "Sorry, I couldn't generate an entry right now. Please try again in a moment.";
                         generatedEntryContainer.classList.remove('hidden');
                    }
                }
            }
            
            loader.classList.add('hidden');
            loader.classList.remove('flex');
            generateBtn.disabled = false;
            generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // --- Firestore Database Functions ---
        async function saveCurrentEntry() {
            if (!currentGeneratedEntry || !currentUserId || !db) return;

            saveBtn.disabled = true;
            saveBtn.innerText = "Saving...";

            try {
                const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/journalEntries`), {
                    text: currentGeneratedEntry,
                    createdAt: serverTimestamp()
                });
                console.log("Document written with ID: ", docRef.id);
                
                // Reset UI after saving
                currentGeneratedEntry = null;
                generatedEntryContainer.classList.add('hidden');
                generatedText.innerText = "";
                
            } catch (e) {
                console.error("Error adding document: ", e);
                // Optionally show an error message to the user
            } finally {
                 saveBtn.disabled = false;
                 saveBtn.innerText = "Save Entry";
            }
        }

        function fetchAndRenderEntries() {
            if (!currentUserId || !db) return;
            const entriesCollection = collection(db, `artifacts/${appId}/users/${currentUserId}/journalEntries`);
            const q = query(entriesCollection);

            onSnapshot(q, (querySnapshot) => {
                const entries = [];
                querySnapshot.forEach((doc) => {
                    entries.push({ id: doc.id, ...doc.data() });
                });

                // Sort entries by date, newest first. Firestore Timestamps can be compared.
                entries.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toMillis() : 0;
                    const dateB = b.createdAt ? b.createdAt.toMillis() : 0;
                    return dateB - dateA;
                });

                renderEntries(entries);
            }, (error) => {
                console.error("Error fetching entries:", error);
                journalHistory.innerHTML = `<p class="text-center text-red-500">Could not load journal history.</p>`;
            });
        }
        
        async function deleteEntry(id) {
            if (!currentUserId || !db || !id) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/journalEntries`, id));
                console.log("Document successfully deleted!");
            } catch (error) {
                console.error("Error removing document: ", error);
            }
        }

        function renderEntries(entries) {
            journalHistory.innerHTML = ''; // Clear existing entries

            if (entries.length === 0) {
                journalHistory.appendChild(emptyState);
            } else {
                emptyState.remove();
                entries.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'relative bg-white/60 p-4 rounded-lg shadow-sm animate-fade-in';
                    entryDiv.dataset.id = entry.id;

                    const date = entry.createdAt ? entry.createdAt.toDate().toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    }) : 'Just now';

                    const dateP = document.createElement('p');
                    dateP.className = 'text-sm font-semibold text-gray-600 mb-2';
                    dateP.textContent = date;
                    
                    const textP = document.createElement('p');
                    textP.className = 'text-gray-800 pr-10'; // Add padding to avoid text overlapping with button
                    textP.textContent = entry.text;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.className = 'absolute top-2 right-2 text-xl text-gray-500 hover:text-red-500 font-bold w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-100 transition-colors';
                    deleteBtn.title = "Delete entry";
                    deleteBtn.onclick = () => deleteEntry(entry.id);

                    entryDiv.appendChild(dateP);
                    entryDiv.appendChild(textP);
                    entryDiv.appendChild(deleteBtn);
                    journalHistory.appendChild(entryDiv);
                });
            }
        }

        // --- Event Listeners ---
        generateBtn.addEventListener('click', generateJournalEntry);
        saveBtn.addEventListener('click', saveCurrentEntry);
    </script>
</body>
</html>

